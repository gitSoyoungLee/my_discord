


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > LocalBinaryContentStorage</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.spirnt.mission.discodeit.storage</a>
</div>

<h1>Coverage Summary for Class: LocalBinaryContentStorage (com.spirnt.mission.discodeit.storage)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">LocalBinaryContentStorage</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    28.6%
  </span>
  <span class="absValue">
    (2/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    9.1%
  </span>
  <span class="absValue">
    (3/33)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.spirnt.mission.discodeit.storage;
&nbsp;
&nbsp;import com.spirnt.mission.discodeit.dto.binaryContent.BinaryContentDto;
&nbsp;import com.spirnt.mission.discodeit.exception.BinaryContent.FileException;
&nbsp;import java.io.File;
&nbsp;import java.io.FileInputStream;
&nbsp;import java.io.FileNotFoundException;
&nbsp;import java.io.FileOutputStream;
&nbsp;import java.io.IOException;
&nbsp;import java.io.InputStream;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.nio.file.Path;
&nbsp;import java.nio.file.Paths;
&nbsp;import java.time.Instant;
&nbsp;import java.util.Map;
&nbsp;import java.util.UUID;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
&nbsp;import org.springframework.core.io.FileSystemResource;
&nbsp;import org.springframework.core.io.Resource;
&nbsp;import org.springframework.http.ContentDisposition;
&nbsp;import org.springframework.http.HttpHeaders;
&nbsp;import org.springframework.http.ResponseEntity;
&nbsp;import org.springframework.stereotype.Component;
&nbsp;
&nbsp;@Component
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@ConditionalOnProperty(name = &quot;discodeit.storage.type&quot;, havingValue = &quot;local&quot;)
<b class="fc">&nbsp;public class LocalBinaryContentStorage implements BinaryContentStorage {</b>
&nbsp;
<b class="fc">&nbsp;  private Path root = Paths.get(System.getProperty(&quot;user.dir&quot;), &quot;localStorage&quot;);</b>
&nbsp;
&nbsp;
&nbsp;  // Bean 생성 시 자동 호출하여 루트 디렉토리 초기화
&nbsp;  // 테스트를 위해 잠시 꺼둠
&nbsp;//  @PostConstruct
&nbsp;  void init() {
<b class="nc">&nbsp;    File[] files = root.toFile().listFiles();</b>
<b class="nc">&nbsp;    if (files != null) {</b>
<b class="nc">&nbsp;      for (File file : files) {</b>
<b class="nc">&nbsp;        if (file.isFile()) {</b>
<b class="nc">&nbsp;          file.delete();</b>
&nbsp;        }
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;  }</b>
&nbsp;
&nbsp;  /// 파일 실제 저장 위치 정의
&nbsp;  Path resolvePath(UUID binaryContentId) {
<b class="nc">&nbsp;    return Paths.get(root + &quot;/&quot; + binaryContentId);</b>
&nbsp;  }
&nbsp;
&nbsp;  // 파일을 로컬에 저장
&nbsp;  @Override
&nbsp;  public UUID put(UUID binaryContentId, byte[] bytes) {
<b class="nc">&nbsp;    Path path = resolvePath(binaryContentId);</b>
<b class="nc">&nbsp;    File file = new File(String.valueOf(path));</b>
<b class="nc">&nbsp;    try (FileOutputStream fos = new FileOutputStream(file)) {</b>
<b class="nc">&nbsp;      fos.write(bytes);</b>
<b class="nc">&nbsp;    } catch (IOException e) {</b>
<b class="nc">&nbsp;      log.warn(&quot;[스토리지에 파일 저장 중 오류가 발생했습니다.]&quot;);</b>
<b class="nc">&nbsp;      throw new FileException(Instant.now(), Map.of(&quot;binaryContentId&quot;, binaryContentId));</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return binaryContentId;</b>
&nbsp;  }
&nbsp;
&nbsp;  // 파일을 InputStream 데이터 타입으로 반환
&nbsp;  @Override
&nbsp;  public InputStream get(UUID binaryContentId) {
<b class="nc">&nbsp;    Path path = resolvePath(binaryContentId);</b>
&nbsp;    try {
<b class="nc">&nbsp;      return new FileInputStream(String.valueOf(path));</b>
<b class="nc">&nbsp;    } catch (FileNotFoundException e) {</b>
<b class="nc">&nbsp;      log.warn(&quot;[스토리지에 파일이 없습니다.]&quot;);</b>
<b class="nc">&nbsp;      throw new FileException(Instant.now(), Map.of(&quot;binaryContentId&quot;, binaryContentId));</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  // 파일 다운로드
&nbsp;  @Override
&nbsp;  public ResponseEntity&lt;Resource&gt; download(BinaryContentDto binaryContentDto) {
<b class="nc">&nbsp;    Path path = resolvePath(binaryContentDto.getId());</b>
<b class="nc">&nbsp;    Resource resource = new FileSystemResource(path);</b>
<b class="nc">&nbsp;    return ResponseEntity.ok()</b>
<b class="nc">&nbsp;        .header(HttpHeaders.CONTENT_TYPE, binaryContentDto.getContentType())</b>
<b class="nc">&nbsp;        .header(HttpHeaders.CONTENT_DISPOSITION, ContentDisposition.attachment() // (6)</b>
<b class="nc">&nbsp;            .filename(binaryContentDto.getFileName(), StandardCharsets.UTF_8)</b>
<b class="nc">&nbsp;            .build()</b>
<b class="nc">&nbsp;            .toString())</b>
<b class="nc">&nbsp;        .body(resource);</b>
&nbsp;  }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-04-07 14:03</div>
</div>
</body>
</html>
